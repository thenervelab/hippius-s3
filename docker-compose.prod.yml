services:
  api:
    command: ["sh", "-c", "python -m hippius_s3.scripts.migrate && gunicorn hippius_s3.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --worker-connections 1000 --max-requests 10000 --max-requests-jitter 1000 --preload --log-level info --access-logfile -"]
    environment:
      - UVICORN_LOG_LEVEL=info
      - DEBUG=false
      - HIPPIUS_IPFS_GET_URL=http://192.168.1.134:8080
      - HIPPIUS_IPFS_STORE_URL=http://192.168.1.134:5001

  redis:
    command: ["redis-server", "/usr/local/etc/redis/redis.conf", "--maxmemory", "200gb"]

  downloader:
    deploy:
      replicas: 20

  ipfs:
    volumes:
      - /ipfs:/data/ipfs
    environment:
      - IPFS_PROFILE=server
      - IPFS_FD_MAX=8192
    user: "1000:1000"

# Remove the ipfs_data volume since we're using host mount
volumes:
  postgres_data:
